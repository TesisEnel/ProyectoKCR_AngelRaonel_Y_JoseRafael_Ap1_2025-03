@layout ClientLayout

@page "/seleccion-servicio"

@inject ClienteService clienteService
@inject TurnoService turnoService
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<div class="servicio-container">

    <img src="/Img-Vector/Union-1.svg" class="vector-decor top-left" />
    <img src="/Img-Vector/Union-2.svg" class="vector-decor top-right" />
    <img src="/Img-Vector/Union.svg" class="vector-decor bottom-left" />
    <img src="/Img-Vector/Union-2.svg" class="vector-decor bottom-right" />

    <div class="center-content">
        <h2 class="cliente-nombre">@NombreParaMostrar</h2>
        <h3 class="titulo-instruccion">SERVICIO A SOLICITAR:</h3>

        <div class="botones-wrapper">
            <button class="btn-servicio btn-express" @onclick="() => AbrirModal(true)">
                Servicio Exprés
                <span class="icon-suffix">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round">
                        <path d="M4 12H20M4 6H16M4 18H12" />
                    </svg>
                </span>
            </button>

            <button class="btn-servicio btn-diseno" @onclick="() => AbrirModal(false)">
                Diseño y Edición
            </button>
        </div>

        <button class="btn-volver" @onclick="IrAtras">VOLVER</button>
    </div>

    @if (mostrarModalExpres || mostrarModalDiseno)
    {
        <div class="modal-backdrop" @onclick="CerrarModal">
            <div class="modal-window" @onclick:stopPropagation>

                <div class="modal-header">
                    <div class="header-logo">
                        <img src="/Img-Vector/logoKCR.png" alt="KCR" height="30" />
                    </div>
                    <h3 class="header-title">
                        @(mostrarModalExpres ? "Servicio Exprés" : "DISEÑO Y EDICION")
                    </h3>
                    <button class="btn-close-x" @onclick="CerrarModal">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round">
                            <path d="M18 6L6 18M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="modal-body">
                    <h4 class="subtitulo-servicios">SERVICIOS:</h4>
                    <div class="watermark-bg">
                        <img src="/Img-Vector/logoKCR.png" alt="" />
                    </div>

                    <div class="grid-botones">
                        @if (mostrarModalExpres)
                        {
                            <button class="btn-grid" @onclick='() => ElegirServicio("COPIA")'>COPIA</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("IMPRESIONES")'>IMPRESIONES</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("ENCUADERNADO")'>ENCUADERNADO</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("ESCANER")'>ESCANER</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("SERVICIOS MULTIPLES")'>SERVICIOS MULTIPLES</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("PLANOS PDF")'>IMPRESION PLANOS PDF</button>
                        }
                        else
                        {
                            <button class="btn-grid" @onclick='() => ElegirServicio("EDICION DE DISEÑO")'>EDICION DE DISEÑO</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("DISEÑO SUBLIMACION")'>DISEÑO SUBLIMACION</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("TARJETAS")'>TARJETAS DE PRESENTACION</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("FLYERS")'>FLYERS/MONTADO</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("SERVICIOS MULTIPLES")'>SERVICIOS MULTIPLES</button>
                            <button class="btn-grid" @onclick='() => ElegirServicio("PLANOS AUTOCAD")'>PLANOS AUTOCAD</button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    @if (mostrarTicket)
    {
        <div class="modal-backdrop" @onclick="CerrarModal">
            <div class="modal-ticket" @onclick:stopPropagation>

                <div class="ticket-logo">
                    <img src="/Img-Vector/LogoFactura.png" alt="KCR Print Center" />
                </div>

                <div class="ticket-info-group">
                    <label>NOMBRE</label>
                    <span class="dato-destacado">@NombreParaMostrar.ToUpper()</span>
                </div>

                <div class="ticket-info-group">
                    <label>AREA</label>
                    <span class="dato-normal">@areaSeleccionada</span>
                </div>

                <div class="ticket-info-group">
                    <label>SERVICIO</label>
                    <span class="dato-destacado">@servicioSeleccionado</span>
                </div>

                <div class="ticket-info-group">
                    <label>TURNO NO.</label>
                    <span class="dato-turno">@codigoTurno</span>
                </div>

                <div class="ticket-info-group">
                    <label>TELEFONO</label>
                    <span class="dato-destacado">@TelefonoParaMostrar</span>
                </div>

                <button class="btn-generar-ticket" @onclick="GenerarTicketFinal">
                    GENERAR TICKET
                </button>

            </div>
        </div>
    }

</div>

@code {
    // 1. CAPTURA DE DATOS DE LA URL
    [SupplyParameterFromQuery(Name = "nombreCliente")]
    public string? NombreRecibido { get; set; }

    [SupplyParameterFromQuery(Name = "telefono")]
    public string? TelefonoRecibido { get; set; }

    [SupplyParameterFromQuery(Name = "cedula")]
    public string? CedulaRecibida { get; set; }

    [SupplyParameterFromQuery(Name = "correo")]
    public string? CorreoRecibido { get; set; }

    // Propiedades para mostrar (con valores por defecto si vienen vacíos)
    public string NombreParaMostrar => string.IsNullOrEmpty(NombreRecibido) ? "Cliente" : NombreRecibido;
    public string TelefonoParaMostrar => string.IsNullOrEmpty(TelefonoRecibido) ? "---" : TelefonoRecibido;

    // 2. VARIABLES DE ESTADO
    private bool mostrarModalExpres = false;
    private bool mostrarModalDiseno = false;
    private bool mostrarTicket = false; // Nuevo estado para el ticket final

    // Datos para el Ticket
    private string areaSeleccionada = "";
    private string servicioSeleccionado = "";
    private string codigoTurno = "";

    // 3. MÉTODOS

    private void AbrirModal(bool esExpres)
    {
        if (esExpres)
        {
            mostrarModalExpres = true;
            areaSeleccionada = "SERVICIO EXPRESS";
        }
        else
        {
            mostrarModalDiseno = true;
            areaSeleccionada = "DISEÑO Y EDICIÓN";
        }
    }

    private void CerrarModal()
    {
        mostrarModalExpres = false;
        mostrarModalDiseno = false;
        mostrarTicket = false;
    }

    // Este método se llama cuando el usuario elige "COPIA", "IMPRESIONES", etc.
    private void ElegirServicio(string servicio)
    {
        servicioSeleccionado = servicio;

        // Generamos un código ficticio basado en el área y el servicio
        // Ej: SE (Servicio Express) - C (Copia) - 01 (Random)
        string prefijoArea = areaSeleccionada == "SERVICIO EXPRESS" ? "SE" : "DE";
        string prefijoServicio = servicio.Substring(0, 1);
        int numeroRandom = new Random().Next(1, 99);

        codigoTurno = $"{prefijoArea}-{prefijoServicio}-{numeroRandom:D2}";

        // Cerramos los menús y mostramos el ticket
        mostrarModalExpres = false;
        mostrarModalDiseno = false;
        mostrarTicket = true;
    }

    private void GenerarTicketFinal()
    {
        Clientes cliente = new Clientes();
        cliente.Nombres = NombreRecibido;
        cliente.Cedula = CedulaRecibida;
        cliente.Correo = CorreoRecibido;
        cliente.Telefono = TelefonoRecibido;
        cliente.Fecha = DateTime.UtcNow;
        clienteService.Guardar(cliente);

    }

    private void IrAtras()
    {
        navigationManager.NavigateTo("/cliente");
    }
}