@layout ClientLayout

@page "/seleccion-servicio"

@using KCR.Models
@using KCR.Services
@using Microsoft.AspNetCore.Components

@inject ClienteService clienteService
@inject TurnoService turnoService
@inject PreFacturaService preFacturaService // ⬅️ Servicio re-inyectado
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<div class="servicio-container">

    <img src="/Img-Vector/Union-1.svg" class="vector-decor top-left" />
    <img src="/Img-Vector/Union-2.svg" class="vector-decor top-right" />
    <img src="/Img-Vector/Union.svg" class="vector-decor bottom-left" />
    <img src="/Img-Vector/Union-2.svg" class="vector-decor bottom-right" />

    <div class="center-content">
        <h2 class="cliente-nombre">@NombreParaMostrar</h2>
        <h3 class="titulo-instruccion">SERVICIO A SOLICITAR:</h3>

        <div class="botones-wrapper">
            <button class="btn-servicio btn-express" @onclick="() => AbrirModal(true)">
                Servicio Exprés
                <span class="icon-suffix">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round">
                        <path d="M4 12H20M4 6H16M4 18H12" />
                    </svg>
                </span>
            </button>

            <button class="btn-servicio btn-diseno" @onclick="() => AbrirModal(false)">
                Diseño y Edición
                <span class="icon-suffix">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round">
                        <path d="M12 20V4M18 14L12 20M12 20L6 14" />
                    </svg>
                </span>
            </button>
        </div>

        <button class="btn-volver" @onclick="IrAtras">VOLVER</button>
    </div>

    @if (mostrarModalExpres)
    {
        <div class="modal-backdrop" @onclick="CerrarModal">
            <div class="modal-window" @onclick:stopPropagation>
                <div class="modal-header">
                    <div class="header-logo">
                        <img src="/Img-Vector/logoKCR.png" alt="KCR" height="30" />
                    </div>
                    <h3 class="header-title">Servicio Exprés</h3>
                    <button class="btn-close-x" @onclick="CerrarModal">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round">
                            <path d="M18 6L6 18M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="modal-body">
                    <h4 class="subtitulo-servicios">SERVICIOS:</h4>
                    <div class="watermark-bg">
                        <img src="/Img-Vector/logoKCR.png" alt="" />
                    </div>
                    <div class="grid-botones">
                        <button class="btn-grid" @onclick='() => ElegirServicio("COPIA")'>COPIA</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("IMPRESIONES")'>IMPRESIONES</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("ENCUADERNADO")'>ENCUADERNADO</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("ESCANER")'>ESCANER</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("SERVICIOS MULTIPLES")'>SERVICIOS MULTIPLES</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("PLANOS PDF")'>IMPRESION PLANOS PDF</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (mostrarModalDiseno)
    {
        <div class="modal-backdrop" @onclick="CerrarModal">
            <div class="modal-window" @onclick:stopPropagation>
                <div class="modal-header">
                    <div class="header-logo">
                        <img src="/Img-Vector/logoKCR.png" alt="KCR" height="30" />
                    </div>
                    <h3 class="header-title">DISEÑO Y EDICION</h3>
                    <button class="btn-close-x" @onclick="CerrarModal">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round">
                            <path d="M18 6L6 18M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="modal-body">
                    <h4 class="subtitulo-servicios">SERVICIOS:</h4>
                    <div class="watermark-bg">
                        <img src="/Img-Vector/logoKCR.png" alt="" />
                    </div>
                    <div class="grid-botones">
                        <button class="btn-grid" @onclick='() => ElegirServicio("EDICION DE DISEÑO")'>EDICION DE DISEÑO</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("DISEÑO SUBLIMACION")'>DISEÑO SUBLIMACION</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("TARJETAS")'>TARJETAS DE PRESENTACION</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("FLYERS")'>FLYERS/MONTADO</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("SERVICIOS MULTIPLES")'>SERVICIOS MULTIPLES</button>
                        <button class="btn-grid" @onclick='() => ElegirServicio("PLANOS AUTOCAD")'>PLANOS AUTOCAD</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (mostrarTicket)
    {
        <div class="modal-backdrop" @onclick="CerrarModal">
            <div class="modal-ticket" @onclick:stopPropagation>

                <div class="ticket-logo">
                    <img src="/Img-Vector/LogoFactura.png" alt="KCR Print Center" />
                </div>

                <div class="ticket-info-group">
                    <label>NOMBRE</label>
                    <span class="dato-destacado">@NombreParaMostrar.ToUpper()</span>
                </div>

                <div class="ticket-info-group">
                    <label>AREA</label>
                    <span class="dato-normal">@areaSeleccionada</span>
                </div>

                <div class="ticket-info-group">
                    <label>SERVICIO</label>
                    <span class="dato-destacado">@servicioSeleccionado</span>
                </div>

                <div class="ticket-info-group">
                    <label>TURNO NO.</label>
                    <span class="dato-turno">@codigoTurno</span>
                </div>

                <div class="ticket-info-group">
                    <label>TELEFONO</label>
                    <span class="dato-destacado">@TelefonoParaMostrar</span>
                </div>

                <button class="btn-generar-ticket" @onclick="GenerarTicketFinal">
                    GENERAR TICKET
                </button>

            </div>
        </div>
    }

</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "IdClienteRecibido")]
    public int IdClienteRecibido { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "NombreRecibido")]
    public string? NombreRecibido { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "CedulaRecibida")]
    public string? CedulaRecibida { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "TelefonoRecibido")]
    public string? TelefonoRecibido { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "CorreoRecibido")]
    public string? CorreoRecibido { get; set; }


    public string NombreParaMostrar => string.IsNullOrWhiteSpace(NombreRecibido) ? "Cliente" : NombreRecibido;
    public string TelefonoParaMostrar => string.IsNullOrEmpty(TelefonoRecibido) ? "---" : TelefonoRecibido;

    private bool mostrarModalExpres = false;
    private bool mostrarModalDiseno = false;
    private bool mostrarTicket = false;

    private string areaSeleccionada = "";
    private string servicioSeleccionado = "";
    private string codigoTurno = "";


    private void AbrirModal(bool esExpres)
    {
        if (esExpres)
        {
            mostrarModalExpres = true;
            mostrarModalDiseno = false;
            areaSeleccionada = "SERVICIO EXPRESS";
        }
        else
        {
            mostrarModalDiseno = true;
            mostrarModalExpres = false;
            areaSeleccionada = "DISEÑO Y EDICIÓN";
        }
    }

    private void CerrarModal()
    {
        mostrarModalExpres = false;
        mostrarModalDiseno = false;
        mostrarTicket = false;
    }

    private async Task ElegirServicio(string servicio)
    {
        servicioSeleccionado = servicio;

        string areaNombre = areaSeleccionada;
        string prefijo = areaNombre.Substring(0, 1).ToUpper();

        if (areaNombre.Contains("EXPRESS", StringComparison.OrdinalIgnoreCase))
        {
            prefijo = "SE";
        }
        else if (areaNombre.Contains("DISEÑO", StringComparison.OrdinalIgnoreCase))
        {
            prefijo = "DE";
        }

        codigoTurno = await turnoService.GenerarSiguienteNumeroTurno(prefijo);

        mostrarModalExpres = false;
        mostrarModalDiseno = false;
        mostrarTicket = true;
    }

    private async Task GenerarTicketFinal()
    {
        string nombreServicioDB = areaSeleccionada;

        var idServicioFinal = await preFacturaService.BuscarIdServicioPorNombre(nombreServicioDB);

        if (idServicioFinal == null)
        {
            Console.WriteLine($"Error: No se encontró el Id para el área '{nombreServicioDB}'. Asegúrese de que existe en la tabla Servicios.");
            mostrarTicket = false; 
            StateHasChanged();
            return;
        }

        var cliente = new Clientes
        {
            IdCliente = IdClienteRecibido,
            Nombres = NombreRecibido,
            Cedula = CedulaRecibida,
            Telefono = TelefonoRecibido,
            Correo = CorreoRecibido,
            Fecha = DateTime.Now
        };

        var guardadoCliente = await clienteService.Guardar(cliente);

        if (!guardadoCliente)
        {
            Console.WriteLine("Error al guardar o actualizar el cliente.");
            return;
        }

        int idClienteFinal = cliente.IdCliente;

        if (idClienteFinal == 0 && !string.IsNullOrEmpty(cliente.Cedula))
        {
            var clienteBuscado = await clienteService.BuscarPorCedula(cliente.Cedula);
            idClienteFinal = clienteBuscado?.IdCliente ?? 0;
        }

        if (idClienteFinal > 0)
        {
            Turnos turno = new Turnos
            {
                IdCliente = idClienteFinal,
                IdServicio = idServicioFinal.Value, 
                NumTurno = codigoTurno,
                Fecha = DateTime.Now,
                Estado = "En Espera"
            };

            var turnoGuardado = await turnoService.Guardar(turno);

            if (turnoGuardado)
            {
                navigationManager.NavigateTo("/cliente");
            }
            else
            {
                Console.WriteLine("Error: Falló el registro del Turno en la base de datos.");
            }
        }
        else
        {
            Console.WriteLine("Error: No se pudo obtener el ID del cliente para el turno.");
        }
    }

    private void IrAtras()
    {
        navigationManager.NavigateTo("/cliente");
    }
}