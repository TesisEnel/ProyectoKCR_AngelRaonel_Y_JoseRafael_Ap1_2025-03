@page "/cliente"
@layout ClientLayout

@inject NavigationManager navigationManager
@rendermode InteractiveServer
@inject ClienteService clienteservice

<div class="client-grid">

    <div class="left-panel-carousel">
        <h2 class="carousel-title">¡Conócenos!</h2>
        <div class="carousel-frame">
            <img src="@currentImage" class="carousel-img fade-animation" key="@currentImage" />
        </div>
    </div>

    <div class="right-panel-form">
        <h1 class="welcome-title">Bienvenidos/as</h1>
        <div class="form-card">

            <div class="form-group cedula-group">
                <label>Cédula:</label>
                <div class="cedula-row">
                    <input type="text" placeholder="000-0000000-0" @bind="cedula" class="styled-input" />
                    <button class="submit btn-outline small" @onclick="BuscarCedulaAsync" disabled="@IsSearching">Buscar</button>
                </div>
                @if (searchMessage is not null)
                {
                    <div class="search-message">@searchMessage</div>
                }
            </div>

            <div class="form-group">
                <label class="required">Digite su nombre:</label>
                <input type="text" placeholder="Nombre" @bind="nombre" class="styled-input" />
            </div>

            <div class="form-group">
                <label>Teléfono:</label>
                <input type="text" placeholder="000-000-0000" @bind="telefono" class="styled-input" />
            </div>

            <div class="form-group">
                <label>Correo Electrónico:</label>
                <input type="email" placeholder="correo@ejemplo.com" @bind="correo" class="styled-input" />
            </div>

            <div class="action-buttons">
                <button class="btn-outline" @onclick="ResetForm">Limpiar</button>
                <button class="btn-solid" @onclick="GuardarYContinuarAsync" disabled="@IsSearching">Continuar</button>
            </div>

        </div>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public int editingClienteId { get; set; } = 0;

    [Parameter]
    [SupplyParameterFromQuery]
    public bool isEditMode { get; set; } = false;

    private string cedula = string.Empty;
    private string nombre = string.Empty;
    private string telefono = string.Empty;
    private string correo = string.Empty;

    private bool IsSearching => isSaving;
    private bool isSaving = false;
    private string? searchMessage = null;

    private readonly string[] images = new[] {
        "/Img-Vector/Carrusel/carr1.png",
        "/Img-Vector/Carrusel/carr2.png",
        "/Img-Vector/Carrusel/carr3.png",
        "/Img-Vector/Carrusel/carr4.png",
        "/Img-Vector/Carrusel/carr5.png"
    };
    private string currentImage = "/Img-Vector/Carrusel/carr1.png";
    private int imageIndex = 0;
    private Timer? _timer;
    private CancellationTokenSource _cancellationTokenSource = new();

    protected override void OnInitialized()
    {
        _timer = new Timer(ChangeImage, null, 0, 5000);
    }

    private void ChangeImage(object? state)
    {
        imageIndex = (imageIndex + 1) % images.Length;
        currentImage = images[imageIndex];
        InvokeAsync(StateHasChanged);
    }

    private async Task BuscarCedulaAsync()
    {
        if (string.IsNullOrWhiteSpace(cedula))
        {
            searchMessage = "Por favor, ingrese un número de cédula para buscar.";
            return;
        }

        if (!EsCedulaValida(cedula))
        {
            searchMessage = "La cédula ingresada no es válida.";
            return;
        }

        isSaving = true;
        searchMessage = "Buscando cliente...";

        try
        {
            var clienteExistente = await clienteservice.BuscarPorCedula(cedula);

            if (clienteExistente is not null)
            {
                editingClienteId = clienteExistente.IdCliente;
                nombre = clienteExistente.Nombres;
                telefono = clienteExistente.Telefono ?? string.Empty;
                correo = clienteExistente.Correo ?? string.Empty;
                isEditMode = true;
                searchMessage = "Cliente encontrado. Confirme sus datos.";
            }
            else
            {
                editingClienteId = 0;
                nombre = string.Empty;
                telefono = string.Empty;
                correo = string.Empty;
                isEditMode = false;
                searchMessage = "Cliente nuevo. Por favor, complete sus datos.";
            }
        }
        catch (Exception ex)
        {
            searchMessage = $"Error al buscar: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private bool ValidarFormulario()
    {
        if (string.IsNullOrWhiteSpace(nombre))
        {
            searchMessage = "El nombre es obligatorio.";
            return false;
        }

        if (!string.IsNullOrWhiteSpace(cedula) && !EsCedulaValida(cedula))
        {
            searchMessage = "La cédula ingresada no es válida.";
            return false;
        }

        return true;
    }

    private async Task GuardarYContinuarAsync()
    {
        if (!ValidarFormulario())
        {
            return;
        }

        isSaving = true;
        searchMessage = "Guardando cliente...";

        try
        {
            var cliente = new Clientes
            {
                IdCliente = editingClienteId,
                Nombres = nombre.ToUpper(),
                Cedula = string.IsNullOrWhiteSpace(cedula) ? null : cedula,
                Telefono = string.IsNullOrWhiteSpace(telefono) ? null : telefono,
                Correo = string.IsNullOrWhiteSpace(correo) ? null : correo,
                Fecha = DateTime.UtcNow
            };

            var saved = await clienteservice.Guardar(cliente);

            if (saved)
            {
                if (cliente.IdCliente == 0)
                {
                    var persisted = await clienteservice.BuscarPorCedula(cliente.Cedula ?? string.Empty);
                    if (persisted is not null)
                    {
                        editingClienteId = persisted.IdCliente;
                    }
                }

                searchMessage = "Cliente guardado correctamente. Redirigiendo...";
                NavegarAServicios();
            }
            else
            {
                searchMessage = "No se pudo guardar el cliente. Intente de nuevo.";
            }
        }
        catch (Exception ex)
        {
            searchMessage = $"Error al guardar: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void NavegarAServicios()
    {
        var uri = navigationManager.GetUriWithQueryParameters("/seleccion-servicio", new Dictionary<string, object?>
        {
            { "IdClienteRecibido", editingClienteId },
            { "NombreRecibido", nombre },
            { "CedulaRecibida", cedula },
            { "TelefonoRecibido", telefono },
            { "CorreoRecibido", correo }
        });

        navigationManager.NavigateTo(uri);
    }

    private bool EsCedulaValida(string pCedula)
    {
        if (string.IsNullOrWhiteSpace(pCedula)) return false;

        string vcCedula = pCedula.Replace("-", "").Replace(" ", "");

        if (vcCedula.Length != 11) return false;

        if (!long.TryParse(vcCedula, out _)) return false;

        int vnTotal = 0;
        int[] digitoMult = new int[11] { 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1 };

        for (int vDig = 1; vDig <= 11; vDig++)
        {
            int vCalculo = int.Parse(vcCedula.Substring(vDig - 1, 1)) * digitoMult[vDig - 1];

            if (vCalculo < 10)
                vnTotal += vCalculo;
            else
                vnTotal += int.Parse(vCalculo.ToString().Substring(0, 1)) + int.Parse(vCalculo.ToString().Substring(1, 1));
        }

        return vnTotal % 10 == 0;
    }

    private void ResetForm()
    {
        editingClienteId = 0;
        isEditMode = false;
        cedula = string.Empty;
        nombre = string.Empty;
        telefono = string.Empty;
        correo = string.Empty;
        searchMessage = null;
    }

    public void Dispose()
    {
        _timer?.Dispose();
        _cancellationTokenSource.Cancel();
        _cancellationTokenSource.Dispose();
    }
}