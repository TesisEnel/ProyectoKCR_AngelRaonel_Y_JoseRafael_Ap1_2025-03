@page "/empleado/{Area}"
@layout ClientLayout
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "EmpleadoExpress, EmpleadoDE, Administrador")]

@inherits OwningComponentBase<TurnoService>
@inject NavigationManager navigationManager
@inject TurnoService turnoService 
@inject ClienteService clienteService 
@inject PreFacturaService preFacturaService
@rendermode InteractiveServer

<div class="employee-queue-container">

    <div class="queue-card-wrapper">
        <div class="queue-card">
            <div class="card-header">
                COLA ÁREA DE @Area.ToUpper()
                @if (isLoading)
                {
                    <span class="loading-indicator">Cargando...</span>
                }
            </div>

            <div class="table-scroll-wrapper">
                <table class="queue-table">
                    <thead>
                        <tr>
                            <th>NOMBRE</th>
                            <th>WHATSAPP</th>
                            <th>TURNO</th>
                            <th>FECHA CREACIÓN</th>
                            <th>ATENDER</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var turno in TurnosEnEspera.OrderBy(t => t.TurnoID))
                        {
                            <tr key="@turno.TurnoID">
                                <td>@turno.NombreCliente</td>
                                <td>@turno.WhatsApp</td>
                                <td>@turno.NumeroTurno</td>
                                <td>@turno.FechaCreacion.ToString("hh:mm tt")</td>
                                <td>
                                    <button class="btn btn-success btn-sm btn-attend" @onclick="() => AtenderCliente(turno.TurnoID)">
                                        Atender
                                    </button>
                                </td>
                            </tr>
                        }
                        @if (TurnosEnEspera.Count == 0 && !isLoading)
                        {
                            <tr><td colspan="5" class="no-data">No hay turnos en espera.</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="action-buttons-wrapper">
        <button class="action-button-large previous" disabled>
            LLAMAR ANTERIOR
        </button>
        <button class="action-button-large next" @onclick="LlamarSiguiente" disabled="@(TurnosEnEspera.Count == 0)">
            LLAMAR SIGUIENTE
        </button>
    </div>
</div>


@code {
    [Parameter]
    public string Area { get; set; } = "DISEÑO Y EDICIÓN";

    private List<TurnoInfoEmpleado> TurnosEnEspera { get; set; } = new List<TurnoInfoEmpleado>();
    private System.Timers.Timer? _queueTimer;
    private bool _isDisposed = false;
    private const int POLL_INTERVAL_MS = 5000;
    private bool isLoading = true;
    private object _lock = new object(); 

    public class TurnoInfoEmpleado
    {
        public int TurnoID { get; set; }
        public string NombreCliente { get; set; } = "N/A";
        public string WhatsApp { get; set; } = "N/A";
        public string NumeroTurno { get; set; } = "N/A";
        public DateTime FechaCreacion { get; set; } = DateTime.Now;
        public string PuestoAtencion { get; set; } = "PUESTO ASIGNADO";
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadTurnos();

        _queueTimer = new System.Timers.Timer(POLL_INTERVAL_MS);
        _queueTimer.Elapsed += OnQueueTimerElapsed;
        _queueTimer.AutoReset = true;
        _queueTimer.Enabled = true;
    }

    private void OnQueueTimerElapsed(object? sender, System.Timers.ElapsedEventArgs e)
    {
        if (System.Threading.Monitor.TryEnter(_lock))
        {
            try
            {
                InvokeAsync(async () =>
                {
                    if (_isDisposed)
                    {
                        return;
                    }
                    await LoadTurnos();
                    StateHasChanged();
                });
            }
            finally
            {
                System.Threading.Monitor.Exit(_lock);
            }
        }
    }

    private async Task LoadTurnos()
    {
        isLoading = true;
        int? idServicioBuscado = null;

        try
        {
            var todosLosServicios = await preFacturaService.ListarServicios();

            var servicioEncontrado = todosLosServicios
                .FirstOrDefault(s => s.Nombre != null &&
                                     s.Nombre.Equals(Area, StringComparison.OrdinalIgnoreCase));

            idServicioBuscado = servicioEncontrado?.IdServicio;


            if (idServicioBuscado == null || idServicioBuscado <= 0)
            {
                TurnosEnEspera = new List<TurnoInfoEmpleado>();
                return;
            }
           var turnosDB = await turnoService.Listar(t =>
                t.Estado == "En Espera" &&
                t.IdServicio == idServicioBuscado); 

    
            var turnosPendientes = turnosDB.Where(t => t.IdCliente > 0).ToList();

            var listaCola = new List<TurnoInfoEmpleado>();

            foreach (var turno in turnosPendientes)
            {
                var cliente = await clienteService.Buscar(turno.IdCliente);

                listaCola.Add(new TurnoInfoEmpleado
                {
                    TurnoID = turno.IdTurno,
                    NombreCliente = cliente?.Nombres ?? "Cliente Desconocido",
                    WhatsApp = cliente?.Telefono ?? "---",
                    NumeroTurno = turno.NumTurno ?? "S/N",
                    FechaCreacion = turno.Fecha
                });
            }

            TurnosEnEspera = listaCola;
        }
        catch (Exception ex)
        {
            if (!_isDisposed)
            {
                Console.WriteLine($"Error al cargar turnos: {ex.Message}");
            }
            TurnosEnEspera = new List<TurnoInfoEmpleado>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LlamarSiguiente()
    {
        if (TurnosEnEspera.Count == 0) return;
        var turnoACtualizar = TurnosEnEspera.OrderBy(t => t.TurnoID).First();
        var success = await turnoService.CambiarEstadoAsync(turnoACtualizar.TurnoID, "En Llamada");
        if (success)
        {
            await LoadTurnos();
        }
        else
        {
            Console.WriteLine($"Error al llamar al turno {turnoACtualizar.TurnoID}.");
        }
    }

    private async Task AtenderCliente(int turnoId)
    {
        var success = await turnoService.CambiarEstadoAsync(turnoId, "En Atención");
        if (success)
        {
            TurnosEnEspera.RemoveAll(t => t.TurnoID == turnoId);
            StateHasChanged();
            navigationManager.NavigateTo($"/prefactura/{turnoId}");
        }
        else
        {
            Console.WriteLine($"Error al cambiar el estado del turno {turnoId} a 'En Atención'.");
        }
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            _isDisposed = true;
            if (_queueTimer != null)
            {
                _queueTimer.Elapsed -= OnQueueTimerElapsed;
                _queueTimer.Stop();
                _queueTimer.Dispose();
                _queueTimer = null;
            }
        }
        base.Dispose(disposing);
    }
}