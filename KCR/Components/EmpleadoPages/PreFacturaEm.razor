@page "/prefactura/{TurnoId:int}"
@layout ClientLayout
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "EmpleadoExpress, EmpleadoDE")]

@inject NavigationManager navigationManager
@inject TurnoService turnoService
@inject PreFacturaService preFacturaService
@rendermode InteractiveServer

@using System.Globalization
@using KCR.Models

<div class="prefactura-container">
    <h1 class="main-title">GENERACIÓN DE PRE-FACTURA</h1>

    @if (isLoading)
    {
        <p class="loading-message">Cargando datos del cliente...</p>
    }
    else if (clienteTurno is null)
    {
        <p class="error-message">Error: No se encontraron datos para el Turno ID: @TurnoId</p>
    }
    else
    {
        <div class="prefactura-grid">
            <div class="client-details-card">
                <h2 class="section-title">Datos del Cliente</h2>
                <div class="data-group">
                    <label>Turno:</label> <span class="data-value highlight">@clienteTurno.NumTurno</span>
                </div>
                <div class="data-group">
                    <label>Nombre:</label> <span class="data-value">@clienteTurno.Clientes.Nombres</span>
                </div>
                <div class="data-group">
                    <label>Servicio Inicial:</label> <span class="data-value">@clienteTurno.Servicios?.Nombre</span>
                </div>

                <div class="summary-box">
                    <h3>RESUMEN DE COBRO</h3>
                    <div class="summary-item">
                        <span>Subtotal:</span>
                        <span>@Subtotal.ToString("C2", culturaDO)</span>
                    </div>
                    <div class="summary-item">
                        <span>ITBIS (18%):</span>
                        <span>@ITBIS.ToString("C2", culturaDO)</span>
                    </div>
                    <div class="summary-item total">
                        <span>TOTAL A PAGAR:</span>
                        <span>@Total.ToString("C2", culturaDO)</span>
                    </div>
                </div>

                <button class="btn-finalizar" @onclick="FinalizarPrefactura" disabled="@(PreFacturaItems.Count == 0)">
                    PASAR A FACTURA FINAL
                </button>
            </div>

            <div class="search-and-details-card">
                <div class="search-area">
                    <input type="text"
                           placeholder="Buscar Productos o Servicios..."
                           @bind="searchQuery"
                           @bind:event="oninput"
                           @bind:after="SearchItemsAsync"
                           class="search-input-large" />
                </div>

                @if (searchResults.Count > 0)
                {
                    <div class="search-results-list">
                        <table class="items-table search-table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th class="col-price">Precio U.</th>
                                    <th class="col-cant">CANT.</th>
                                    <th class="col-action"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var result in searchResults)
                                {
                                    <tr>
                                        <td>@(result.Servicios?.Nombre ?? result.Materiales?.Nombre)</td>
                                        <td class="col-price">@result.PrecioUnitario.ToString("C2", culturaDO)</td>
                                        <td class="col-cant">
                                            <input type="number" @bind="result.Cantidad" min="1" class="qty-input" />
                                        </td>
                                        <td class="col-action">
                                            <button class="btn-add-item-small" @onclick="() => AddToPreFactura(result)">
                                                <i class="fa-solid fa-plus"></i> AÑADIR
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <h2 class="section-title items-title">Detalle de Pre-Factura (@PreFacturaItems.Count)</h2>
                <div class="prefactura-items-table-wrapper">

                    <table class="items-table header-fixed">
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th class="col-cant">Cant.</th>
                                <th class="col-price">Precio U.</th>
                                <th class="col-total">Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in PreFacturaItems)
                            {
                                <tr>
                                    <td>@(item.Servicios?.Nombre ?? item.Materiales?.Nombre)</td>
                                    <td class="col-cant">
                                        <input type="number" @bind="item.Cantidad" min="1" class="qty-input" @bind:after="CalculateTotals" />
                                    </td>
                                    <td class="col-price">@item.PrecioUnitario.ToString("C2", culturaDO)</td>
                                    <td class="col-total">@((item.Cantidad * item.PrecioUnitario).ToString("C2", culturaDO))</td>
                                    <td><span class="delete-icon" @onclick="() => RemoveItem(item)">×</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int TurnoId { get; set; }

    private bool isLoading = true;
    private bool isSearching = false;
    private Turnos? clienteTurno;
    private string searchQuery = string.Empty;

    private List<PreFacturaDetalles> searchResults = new();
    private List<PreFacturaDetalles> PreFacturaItems = new();

    private readonly System.Globalization.CultureInfo culturaDO = new("es-DO");

    private string AreaActual => clienteTurno?.Servicios?.Nombre ?? "Turnos";

    private decimal Subtotal => PreFacturaItems.Sum(i => i.Cantidad * i.PrecioUnitario);
    private decimal ITBIS => Subtotal * 0.18M;
    private decimal Total => Subtotal + ITBIS;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        clienteTurno = await turnoService.Buscar(TurnoId);
        isLoading = false;
    }


    private async Task SearchItemsAsync()
    {
        if (string.IsNullOrWhiteSpace(searchQuery) || searchQuery.Length < 1)
        {
            searchResults = new();
            return;
        }

        isSearching = true;
        searchResults = await preFacturaService.BuscarInventario(searchQuery);
        isSearching = false;
    }

    private void AddToPreFactura(PreFacturaDetalles newItem)
    {
        if (newItem.Cantidad <= 0) return;

        var existingItem = PreFacturaItems.FirstOrDefault(i =>
            (i.IdServicio != null && i.IdServicio == newItem.IdServicio) ||
            (i.IdMaterial != null && i.IdMaterial == newItem.IdMaterial));

        if (existingItem != null)
        {
            existingItem.Cantidad += newItem.Cantidad;
        }
        else
        {
            var itemToAdd = new PreFacturaDetalles
            {
                IdServicio = newItem.IdServicio,
                IdMaterial = newItem.IdMaterial,
                PrecioUnitario = newItem.PrecioUnitario,
                Cantidad = newItem.Cantidad,
                Servicios = newItem.Servicios,
                Materiales = newItem.Materiales
            };
            PreFacturaItems.Add(itemToAdd);
        }

        searchQuery = string.Empty;
        searchResults.Clear();
        CalculateTotals();
    }

    private void RemoveItem(PreFacturaDetalles item)
    {
        PreFacturaItems.Remove(item);
        CalculateTotals();
    }

    private void CalculateTotals()
    {
        StateHasChanged();
    }

    private async Task FinalizarPrefactura()
    {
        if (PreFacturaItems.Count == 0 || clienteTurno == null) return;

        var nuevaPreFactura = new PreFacturas
        {
            IdCliente = clienteTurno.Clientes.IdCliente,
            NombreCliente = clienteTurno.Clientes.Nombres,
            Fecha = DateTime.Now,
            Estado = "Pendiente", 
            Total = this.Total,
            IdTurno = this.TurnoId,
            PreFacturaDetalles = new List<PreFacturaDetalles>()
        };

        foreach (var item in PreFacturaItems)
        {
            var detalleLimpio = new PreFacturaDetalles
            {
                IdServicio = item.IdServicio,
                IdMaterial = item.IdMaterial,
                Cantidad = item.Cantidad,
                PrecioUnitario = item.PrecioUnitario,
                Servicios = null,
                Materiales = null
            };

            nuevaPreFactura.PreFacturaDetalles.Add(detalleLimpio);
        }

        var resultadoGuardado = await preFacturaService.Guardar(nuevaPreFactura);

        if (resultadoGuardado)
        {
            await turnoService.CambiarEstadoAsync(TurnoId, "Pre-Facturado");
            navigationManager.NavigateTo($"/empleado/{AreaActual}");
        }
        else
        {
            Console.WriteLine("Error al guardar la Pre-Factura.");
        }
    }
}
