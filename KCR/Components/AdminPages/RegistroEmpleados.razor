@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrador")]

@page "/registro-empleado"

@layout MainLayout
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using KCR.Data
@using KCR.Services
@using System.Linq @* <-- ¡La más probable para su error actual! *@

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ILogger<RegistroEmpleados> Logger

[SupplyParameterFromQuery(Name = "mode")]
public string? Mode { get; set; }

[SupplyParameterFromQuery(Name = "id")]
public int? EmpleadoId { get; set; }

<div class="registro-container">

    <div class="form-card">
        <div class="card-header">
            <h3>Registro de Empleado</h3>
        </div>

        <EditForm Model="Input" OnValidSubmit="GuardarEmpleado" FormName="registro-empleado-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <div class="card-body">
                <p class="@(string.IsNullOrEmpty(statusMessage) || statusMessage.StartsWith("Éxito") ? "text-success" : "text-danger")" 
                   role="alert">@statusMessage</p>

                <div class="form-row">
                    <label>IdEmpleado</label>
                    <input type="text" class="input-corto" readonly value="EmpleadoId ?? Nuevo" />
                </div>

                <div class="form-row">
                    <label>Nombre</label>
                    <InputText type="text" @bind-Value="Input.Nombre" />
                    <ValidationMessage For="() => Input.Nombre" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Cédula</label>
                    <InputText type="text" @bind-Value="Input.Cedula" />
                    <ValidationMessage For="() => Input.Cedula" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Cargo</label>
                    <InputText type="text" @bind-Value="Input.Cargo" />
                    <ValidationMessage For="() => Input.Cargo" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Usuario (Email)</label>
                    @* Usamos Input.Email para la validación de email/username *@
                    <InputText type="email" @bind-Value="Input.Email" />
                    <ValidationMessage For="() => Input.Email" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Clave</label>
                    <InputText type="password" @bind-Value="Input.Password" />
                    <ValidationMessage For="() => Input.Password" class="text-danger" />
                </div>
            </div>

            <div class="card-footer-buttons">
                <button type="button" class="btn-volver" @onclick="IrAtras">Volver</button>
                <button type="submit" class="btn-guardar">Guardar</button>
            </div>
        </EditForm>
    </div>

    <img src="/Img-Vector/Union.svg" class="vector-corner" />
</div>

@code {
    private string? statusMessage;

    // Usamos un InputModel para la validación y binding
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override void OnInitialized()
    {
        Input ??= new InputModel();
    }

    private async Task GuardarEmpleado()
    {
        statusMessage = null;
        
        // 1. Crear y poblar el objeto ApplicationUser con todos los datos
        var user = new ApplicationUser
        {
            UserName = Input.Email, 
            Email = Input.Email,
            EmailConfirmed = true,
            
            // Asignación de las propiedades extendidas:
            Nombre = Input.Nombre, 
            Cedula = Input.Cedula,
            Cargo = Input.Cargo 
        };

        // 2. Intentar crear el usuario en la base de datos
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            // 3. Asignar el rol de 'Empleado' (el que definiste en IdentitySeeder)
            var roleResult = await UserManager.AddToRoleAsync(user, IdentitySeeder.EmployeeRole);

            if (roleResult.Succeeded)
            {
                Logger.LogInformation("Usuario y rol de empleado registrados correctamente.");
                statusMessage = $"Éxito: Empleado {Input.Email} registrado y rol '{IdentitySeeder.EmployeeRole}' asignado.";
                
                // Limpiar el formulario
                Input = new InputModel();
            }
            else
            {
                // Revertir: Eliminar el usuario si la asignación de rol falla.
                await UserManager.DeleteAsync(user);
                statusMessage = $"Error al asignar el rol: {string.Join(", ", roleResult.Errors.Select(e => e.Description))}";
            }
        }
        else
        {
            // Mostrar errores de Identity (ej. "DuplicateUserName")
            statusMessage = $"Error al crear el usuario: {string.Join(", ", result.Errors.Select(e => e.Description))}";
        }
    }

    private void IrAtras()
    {
        Navigation.NavigateTo("/pantalla-principal-admin");
    }

    // -------------------------------------------------------------------------------------------------
    // Modelo para la Entrada y Validación
    // -------------------------------------------------------------------------------------------------
    public sealed class InputModel
    {
        // NOTA: Usamos Email y Password para los InputText, ya que tienen DataAnnotations
        
        // Campos Identity
        [Required(ErrorMessage = "El correo es requerido.")]
        [EmailAddress(ErrorMessage = "Formato de correo inválido.")]
        [Display(Name = "Usuario/Email")]
        public string Email { get; set; } = "";
        
        [Required(ErrorMessage = "La clave es requerida.")]
        [StringLength(100, ErrorMessage = "La clave debe tener al menos {2} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Clave")]
        public string Password { get; set; } = "";

        // Campos específicos del Empleado
        // Utilizamos tus DataAnnotations para la validación:
        [Required(ErrorMessage = "Todos los campos son obligatorios")]
        public string Nombre { get; set; } = "";
        
        [Required(ErrorMessage = "Todos los campos son obligatorios")]
        public string Cedula { get; set; } = "";
        
        [Required(ErrorMessage = "Todos los campos son obligatorios")]
        public string Cargo { get; set; } = "";
    }
}