@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrador")]

@page "/registro-empleado"

@layout MainLayout
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using KCR.Data


@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ILogger<RegistroEmpleados> Logger
@* --- NUEVO: Inyectamos el servicio para guardar en la tabla Empleados --- *@
@inject EmpleadoService empleadoService

<div class="registro-container">

    <div class="form-card">
        <div class="card-header">
            <h3>Registro de Empleado</h3>
        </div>

        <EditForm Model="Input" OnValidSubmit="GuardarEmpleado" FormName="registro-empleado-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <div class="card-body">
                <p class="@(string.IsNullOrEmpty(statusMessage) || statusMessage.StartsWith("Éxito") ? "text-success" : "text-danger")"
                   role="alert">@statusMessage</p>

                <div class="form-row">
                    <label>IdEmpleado</label>
                    <input type="text" class="input-corto" readonly value="Auto" />
                </div>

                <div class="form-row">
                    <label>Nombre</label>
                    <InputText type="text" @bind-Value="Input.Nombre" />
                    <ValidationMessage For="() => Input.Nombre" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Cédula</label>
                    <InputText type="text" @bind-Value="Input.Cedula" />
                    <ValidationMessage For="() => Input.Cedula" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Cargo / Rol</label>
                    <InputSelect @bind-Value="Input.Cargo" class="form-control">
                        <option value="">-- Seleccione Rol --</option>
                        <option value="EmpleadoExpress">Empleado Express</option>
                        <option value="EmpleadoDE">Empleado Diseño y Edición</option>
                    </InputSelect>
                    <ValidationMessage For="() => Input.Cargo" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Usuario (Email)</label>
                    <InputText type="email" @bind-Value="Input.Email" />
                    <ValidationMessage For="() => Input.Email" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Clave</label>
                    <InputText type="password" @bind-Value="Input.Password" />
                    <ValidationMessage For="() => Input.Password" class="text-danger" />
                </div>
            </div>

            <div class="card-footer-buttons">
                <button type="button" class="btn-volver" @onclick="IrAtras">Volver</button>
                <button type="submit" class="btn-guardar">Guardar</button>
            </div>
        </EditForm>
    </div>

    <img src="/Img-Vector/Union.svg" class="vector-corner" />
</div>

@code {
    private string? statusMessage;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override void OnInitialized()
    {
        Input ??= new InputModel();
    }

    private async Task GuardarEmpleado()
    {
        statusMessage = null;

        // 1. Crear el objeto ApplicationUser (Identity)
        var user = new ApplicationUser
        {
            UserName = Input.Email,
            Email = Input.Email,
            EmailConfirmed = true,
            Nombre = Input.Nombre,
            Cedula = Input.Cedula,
            Cargo = Input.Cargo
        };

        // 2. Intentar crear el usuario en Identity (Sistema de Login)
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            // 3. Asignar el Rol seleccionado en el formulario
            // Usamos Input.Cargo directamente porque los valores del select ("EmpleadoExpress", "EmpleadoDE")
            // coinciden con los nombres de tus roles.
            var roleResult = await UserManager.AddToRoleAsync(user, Input.Cargo);

            if (roleResult.Succeeded)
            {
                // --- NUEVO: Sincronizar con la tabla de negocio 'Empleados' ---
                // Esto es vital para que no falle la facturación (Foreign Key error)
                var nuevoEmpleadoBD = new Empleados
                {
                    Nombre = Input.Nombre,
                    Usuario = Input.Email, // Este campo vincula ambas tablas
                    Cedula = Input.Cedula,
                    Cargo = Input.Cargo,
                    Clave = "******" // Ponemos un placeholder o Input.Password si prefieres
                };

                var guardadoBD = await empleadoService.Insertar(nuevoEmpleadoBD);

                if (guardadoBD)
                {
                    Logger.LogInformation("Usuario registrado en Identity y Base de Datos local.");
                    statusMessage = $"Éxito: Empleado registrado correctamente con rol '{Input.Cargo}'.";
                    Input = new InputModel(); // Limpiar formulario
                }
                else
                {
                    // Si falla guardar en la tabla Empleados, podríamos considerar borrar el usuario de Identity
                    // para mantener la consistencia, o solo avisar.
                    statusMessage = "Advertencia: El usuario se creó el login, pero falló al guardar en la tabla de empleados.";
                }
                // -------------------------------------------------------------
            }
            else
            {
                await UserManager.DeleteAsync(user);
                statusMessage = $"Error al asignar rol: {string.Join(", ", roleResult.Errors.Select(e => e.Description))}";
            }
        }
        else
        {
            statusMessage = $"Error al crear usuario: {string.Join(", ", result.Errors.Select(e => e.Description))}";
        }
    }

    private void IrAtras()
    {
        Navigation.NavigateTo("/pantalla-principal-admin");
    }

    public sealed class InputModel
    {
        [Required(ErrorMessage = "El correo es requerido.")]
        [EmailAddress(ErrorMessage = "Formato inválido.")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "La clave es requerida.")]
        [StringLength(100, ErrorMessage = "Mínimo {2} caracteres.", MinimumLength = 6)]
        public string Password { get; set; } = "";

        [Required(ErrorMessage = "El nombre es requerido")]
        public string Nombre { get; set; } = "";

        [Required(ErrorMessage = "La cédula es requerida")]
        public string Cedula { get; set; } = "";

        [Required(ErrorMessage = "Debe seleccionar un cargo")]
        public string Cargo { get; set; } = "";
    }
}