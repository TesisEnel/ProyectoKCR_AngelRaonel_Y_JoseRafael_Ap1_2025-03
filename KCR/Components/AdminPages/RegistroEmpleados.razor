@attribute [Authorize(Roles = "Administrador")]
@page "/registro-empleado"
@layout MainLayout
@rendermode InteractiveServer
@inject ToastService toastService
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager navigationManager
@inject ILogger<RegistroEmpleados> Logger
@inject EmpleadoService empleadoService

<div class="registro-container">
    <div class="form-card">
        <div class="card-header">
            <h3>Registro de Empleado</h3>
        </div>
        <Toasts class="p-3 toast-grande" AutoHide="true" Delay="4000" Placement="ToastsPlacement.TopRight" />
        <EditForm Model="Input" OnValidSubmit="GuardarEmpleado" FormName="registro-empleado-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <div class="card-body">
                <p class="@(string.IsNullOrEmpty(statusMessage) || statusMessage.StartsWith("Éxito") ? "text-success" : "text-danger")" role="alert">@statusMessage</p>

                <div class="form-row">
                    <label>IdEmpleado</label>
                    <input type="text" class="input-corto" readonly value="Auto" />
                </div>

                <div class="form-row">
                    <label>Nombre</label>
                    <InputText type="text" @bind-Value="Input.Nombre" />
                    <ValidationMessage For="() => Input.Nombre" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Cédula</label>
                    <InputText type="text" @bind-Value="Input.Cedula" />
                    <ValidationMessage For="() => Input.Cedula" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Cargo / Rol</label>
                    <InputSelect @bind-Value="Input.Cargo" class="form-control">
                        <option value="">-- Seleccione Rol --</option>
                        <option value="EmpleadoExpress">Empleado Express</option>
                        <option value="EmpleadoDE">Empleado Diseño y Edición</option>
                    </InputSelect>
                    <ValidationMessage For="() => Input.Cargo" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Usuario (Email)</label>
                    <InputText type="email" @bind-Value="Input.Email" />
                    <ValidationMessage For="() => Input.Email" class="text-danger" />
                </div>

                <div class="form-row">
                    <label>Clave</label>
                    <InputText type="password" @bind-Value="Input.Password" />
                    <ValidationMessage For="() => Input.Password" class="text-danger" />
                </div>
            </div>

            <div class="card-footer-buttons">
                <button type="button" class="btn-volver" @onclick="IrAtras">Volver</button>
                <button type="submit" class="btn-guardar">Guardar</button>
            </div>
        </EditForm>
    </div>
    <img src="/Img-Vector/Union.svg" class="vector-corner" />
</div>

@code {
    private string? statusMessage;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override void OnInitialized()
    {
        Input ??= new InputModel();
    }

    private async Task GuardarEmpleado()
    {
        statusMessage = null;

        if (!EsCedulaValida(Input.Cedula))
        {
            statusMessage = "Error: La cédula ingresada no es válida (Verifique los dígitos).";
            toastService.ShowError("Cédula inválida");
            return;
        }

        var existeEnBD = await empleadoService.Listar(e => e.Cedula == Input.Cedula);
        if (existeEnBD.Any())
        {
            statusMessage = "Error: Ya existe un empleado registrado con esta cédula.";
            toastService.ShowError("La cédula ya existe en el sistema");
            return;
        }

        var user = new ApplicationUser
        {
            UserName = Input.Email,
            Email = Input.Email,
            EmailConfirmed = true,
            Nombre = Input.Nombre,
            Cedula = Input.Cedula,
            Cargo = Input.Cargo
        };

        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            var roleResult = await UserManager.AddToRoleAsync(user, Input.Cargo);

            if (roleResult.Succeeded)
            {
                var nuevoEmpleadoBD = new Empleados
                {
                    Nombre = Input.Nombre,
                    Usuario = Input.Email,
                    Cedula = Input.Cedula,
                    Cargo = Input.Cargo,
                    Clave = "******"
                };

                var guardadoBD = await empleadoService.Guardar(nuevoEmpleadoBD);

                if (guardadoBD)
                {
                    Logger.LogInformation("Usuario registrado en Identity y Base de Datos local.");
                    statusMessage = $"Éxito: Empleado registrado correctamente con rol '{Input.Cargo}'.";
                    Input = new InputModel();
                    toastService.ShowSuccess("El empleado se guardo correctamente");
                    await Task.Delay(4000);
                    navigationManager.NavigateTo("/lista-empleados");
                }
            }
            else
            {
                await UserManager.DeleteAsync(user);
                statusMessage = $"Error al asignar rol: {string.Join(", ", roleResult.Errors.Select(e => e.Description))}";
            }
        }
        else
        {
            statusMessage = $"Error al crear usuario: {string.Join(", ", result.Errors.Select(e => e.Description))}";
            toastService.ShowError("Error al crear usuario");
            await Task.Delay(4000);
        }
    }

    private bool EsCedulaValida(string pCedula)
    {
        if (string.IsNullOrWhiteSpace(pCedula)) return false;

        string vcCedula = pCedula.Replace("-", "").Replace(" ", "");

        if (vcCedula.Length != 11) return false;

        if (!long.TryParse(vcCedula, out _)) return false;

        int vnTotal = 0;
        int[] digitoMult = new int[11] { 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1 };

        for (int vDig = 1; vDig <= 11; vDig++)
        {
            int vCalculo = int.Parse(vcCedula.Substring(vDig - 1, 1)) * digitoMult[vDig - 1];

            if (vCalculo < 10)
                vnTotal += vCalculo;
            else
                vnTotal += int.Parse(vCalculo.ToString().Substring(0, 1)) + int.Parse(vCalculo.ToString().Substring(1, 1));
        }

        return vnTotal % 10 == 0;
    }

    private void IrAtras()
    {
        navigationManager.NavigateTo("/pantalla-principal-admin");
    }

    public sealed class InputModel
    {
        [Required(ErrorMessage = "El correo es requerido.")]
        [EmailAddress(ErrorMessage = "Formato inválido.")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "La clave es requerida.")]
        [StringLength(100, ErrorMessage = "Mínimo {2} caracteres.", MinimumLength = 6)]
        public string Password { get; set; } = "";

        [Required(ErrorMessage = "El nombre es requerido")]
        public string Nombre { get; set; } = "";

        [Required(ErrorMessage = "La cédula es requerida")]
        public string Cedula { get; set; } = "";

        [Required(ErrorMessage = "Debe seleccionar un cargo")]
        public string Cargo { get; set; } = "";
    }
}