@attribute [Authorize(Roles = "Administrador")]
@page "/registro-material"
@page "/modificar-material/{IdMaterial:int}"
@layout MainLayout
@rendermode InteractiveServer
@using KCR.Models
@using KCR.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject ToastService toastService
@inject NavigationManager navigationManager
@inject MaterialesService materialesService

<div class="pantalla-wrapper">
    <div class="client-grid">
        <div class="right-panel-form" style="width: 100%;">
            <h1 class="welcome-title">
                @(IdMaterial > 0 ? "Modificar Material" : "Registro de Material")
            </h1>

            <div class="form-card login-card">
                <Toasts class="p-3 toast-grande" AutoHide="true" Delay="4000" Placement="ToastsPlacement.TopRight" />

                <EditForm Model="Input" OnValidSubmit="GuardarMaterial" FormName="registro-material-form">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" role="alert" />
                    <p class="@(string.IsNullOrEmpty(statusMessage) || statusMessage.StartsWith("Éxito") ? "text-success" : "text-danger")"
                       role="alert" style="text-align:center; margin-bottom: 1rem;">@statusMessage</p>
                    <table class="modern-form-table">
                        <thead>
                            <tr>
                                <th>Campo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>ID Material:</strong></td>
                                <td>
                                    <input type="text" class="styled-input readonly"
                                           readonly value="@(IdMaterial > 0 ? IdMaterial.ToString() : "Auto")" />
                                </td>
                            </tr>
                            <tr>
                                <td><label class="required">Nombre:</label></td>
                                <td>
                                    <InputText @bind-Value="Input.Nombre" class="styled-input" placeholder="Nombre del material" />
                                    <ValidationMessage For="() => Input.Nombre" class="text-danger" />
                                </td>
                            </tr>
                            <tr>
                                <td><label class="required">Existencia:</label></td>
                                <td>
                                    <InputNumber @bind-Value="Input.Existencia"
                                                 class="styled-input"
                                                 Culture="System.Globalization.CultureInfo.InvariantCulture"
                                                 step="0.01" />
                                    <ValidationMessage For="() => Input.Existencia" class="text-danger" />
                                </td>
                            </tr>
                            <tr>
                                <td><label class="required">Precio Unitario ($):</label></td>
                                <td>
                                    <InputNumber @bind-Value="Input.PrecioUnitario"
                                                 class="styled-input"
                                                 Culture="System.Globalization.CultureInfo.InvariantCulture" />
                                    <ValidationMessage For="() => Input.PrecioUnitario" class="text-danger" />
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2" class="table-footer">
                                    <div class="table-action-buttons">
                                        <button type="button" class="btn-volver" @onclick="IrAListaMateriales">
                                            <i class="bi bi-arrow-left"></i> Volver
                                        </button>
                                        <button type="submit" class="btn-guardar">
                                            <i class="bi bi-check-circle"></i> @(IdMaterial > 0 ? "Actualizar" : "Guardar")
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int IdMaterial { get; set; }

    private string? statusMessage;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        if (IdMaterial > 0)
        {
            var materialEnBD = await materialesService.Buscar(IdMaterial);

            if (materialEnBD != null)
            {
                Input.Nombre = materialEnBD.Nombre;
                Input.Existencia = materialEnBD.Existencia;
                Input.PrecioUnitario = materialEnBD.PrecioUnitario;
            }
            else
            {
                statusMessage = $"Error: Material con ID {IdMaterial} no encontrado.";
                toastService.ShowError("Material no existe");
            }
        }
        else
        {
            Input = new InputModel();
        }
    }

    private async Task GuardarMaterial()
    {
        statusMessage = null;
        bool guardado;

        var material = new Materiales
        {
            IdMaterial = IdMaterial,
            Nombre = Input.Nombre,
            Existencia = Input.Existencia, 
            PrecioUnitario = Input.PrecioUnitario,
            Activo = true
        };

        if (IdMaterial > 0)
        {
            var materialExistente = await materialesService.Buscar(IdMaterial);
            if (materialExistente != null)
            {
                material.Activo = materialExistente.Activo;
            }
        }

        guardado = await materialesService.Guardar(material);

        if (guardado)
        {
            statusMessage = IdMaterial > 0 ? "Éxito: Material actualizado correctamente." : "Éxito: Material registrado correctamente.";
            toastService.ShowSuccess(statusMessage);
            await Task.Delay(1500);
            IrAListaMateriales();
        }
        else
        {
            statusMessage = IdMaterial > 0 ? "Error al actualizar el material." : "Error al registrar el material.";
            toastService.ShowError(statusMessage);
        }
    }

    private void IrAListaMateriales()
    {
        navigationManager.NavigateTo("/lista-materiales");
    }

    public sealed class InputModel
    {
        [Required(ErrorMessage = "El nombre es obligatorio")]
        public string Nombre { get; set; } = string.Empty;

        [Required(ErrorMessage = "La existencia es requerida")]
        [Range(0.0, double.MaxValue, ErrorMessage = "La existencia debe ser mayor o igual a 0")]
        public double Existencia { get; set; } = 0.0;

        [Required(ErrorMessage = "El precio unitario es requerido")]
        [Range(0.01, double.MaxValue, ErrorMessage = "El precio unitario debe ser mayor que 0")]
        public double PrecioUnitario { get; set; }
    }
}