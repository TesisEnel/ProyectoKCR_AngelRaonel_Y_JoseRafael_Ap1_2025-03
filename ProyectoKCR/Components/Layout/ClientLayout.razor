@inherits LayoutComponentBase
@implements IDisposable


<div class="kiosk-container">
    <header class="kiosk-header">
        <div class="header-left">
            <img src="img-Vector/logoKCR.png" alt="KCR Print Center" class="header-logo-img" />
        </div>

        <div class="header-center">
            SISTEMA DE TURNOS
        </div>

        <div class="header-right">
            HORA <span class="time-display">@currentTime</span>
        </div>
    </header>

    <main class="kiosk-content">
        @Body
    </main>

    <div class="decorations">
        <img src="/Img-Vector/Union.svg" class="vector-decor top-left" alt="" />
        <img src="/Img-Vector/Union-1.svg" class="vector-decor top-right" alt="" />
        <img src="/Img-Vector/Union-2.svg" class="vector-decor bottom-left" alt="" />
        <img src="/Img-Vector/Union.svg" class="vector-decor bottom-right" alt="" />
    </div>
</div>

@code {
    private string currentTime = DateTime.Now.ToString("hh:mm:ss");
    // Usamos CancellationTokenSource para detener el bucle cuando el componente se destruye
    private CancellationTokenSource _clockCts = new CancellationTokenSource();

    protected override  Task OnInitializedAsync()
    {
        StartClockLoop();

        // 2. Devolvemos Task.CompletedTask para que Blazor sepa que el componente
        // puede continuar con el renderizado de la UI.
        return Task.CompletedTask;
    }

    private async Task StartClockLoop()
    {
        var token = _clockCts.Token;

        while (!token.IsCancellationRequested)
        {
            try
            {
                // 1. Espera 1 segundo
                await Task.Delay(1000, token);
            }
            catch (TaskCanceledException)
            {
                // El componente se cerró, salimos del bucle
                return;
            }

            // 2. Actualiza la hora y notifica a Blazor
            currentTime = DateTime.Now.ToString("hh:mm:ss");
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        // Detenemos el bucle al destruir el componente
        _clockCts.Cancel();
        _clockCts.Dispose();
    }
}